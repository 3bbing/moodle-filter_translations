{"version":3,"sources":["../src/translation_button.js"],"names":["define","$","ModalFactory","Str","templates","translation_button","findandinjectbuttons","on","opentranslation","elems","findElementsDirectlyContainingText","document","forEach","elem","binary","exec","html","replace","key","parseInt","render","done","append","translationinfo","objects","staletranslation","addClass","goodtranslation","event","stopPropagation","preventDefault","context","data","get_strings","component","then","langStrings","create","title","body","type","types","ALERT","modal","show","fail","Notification","exception","ancestor","text","elements","walk","element","n","childNodes","length","i","child","nodeType","indexOf","push"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @package filter_translations\n * @author Andrew Hancox <andrewdchancox@googlemail.com>\n * @author Open Source Learning <enquiries@opensourcelearning.co.uk>\n * @link https://opensourcelearning.co.uk\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @copyright 2021, Andrew Hancox\n */\n\ndefine(['jquery', 'core/modal_factory', 'core/str', 'core/templates'], function ($, ModalFactory, Str, templates) {\n    var translation_button = {\n        'init': function () {\n            translation_button.findandinjectbuttons();\n            $('body').on('click', '.filter_translations_btn_translate', translation_button.opentranslation);\n            $('body').on('contextmenu', '.filter_translations_btn_translate', translation_button.opentranslation);\n        },\n        'findandinjectbuttons': function() {\n            var encodedone = \"\\u{200B}\"; // Zero-Width Space\n            var encodedzero = \"\\u{200C}\"; // Zero-Width Non-Joiner\n            var encodedseperator = \"\\u{200D}\"; // Zero-Width Joiner\n\n            var elems = translation_button.findElementsDirectlyContainingText(document, encodedseperator + encodedseperator);\n            elems.forEach(function(elem) {\n                var matches = new RegExp(encodedseperator + encodedseperator + '([' + encodedone + encodedzero + ']*)');\n\n                var regexzero = new RegExp(encodedzero, 'g');\n                var regexone = new RegExp(encodedone, 'g');\n\n                var binary = matches.exec($(elem).html())[1].replace(regexone, '1').replace(regexzero, '0');\n                var key = parseInt(binary, 2);\n\n                templates.render('filter_translations/translatebutton', {'inpagetranslationid': key}).done(function (html) {\n                    $(elem).append(html);\n\n                    var translationinfo = translation_button.objects[key];\n                    if (translationinfo.staletranslation) {\n                        $('.filter_translations_btn_translate[data-inpagetranslationid=' + key + ']').addClass('alert-warning');\n                    } else if (translationinfo.goodtranslation) {\n                        $('.filter_translations_btn_translate[data-inpagetranslationid=' + key + ']').addClass('alert-success');\n                    }\n                });\n            });\n        },\n        'opentranslation': function (event) {\n            event.stopPropagation();\n            event.preventDefault();\n\n            var context = context = translation_button.objects[$(this).data('inpagetranslationid')];\n\n            Str.get_strings([{\n                key: 'translationdetails',\n                component: 'filter_translations'\n            }]).then(function (langStrings) {\n                return templates.render('filter_translations/translationdetailsmodalbody', context).done(function (html) {\n                    ModalFactory.create({\n                        title: langStrings[0],\n                        body: html,\n                        type: ModalFactory.types.ALERT\n                    }).then(function (modal) {\n                        modal.show();\n                    });\n                });\n            }).fail(Notification.exception);\n        },\n        'register': function (key, translationinfo) {\n            translation_button.objects[key] = translationinfo;\n\n            if (translationinfo.staletranslation) {\n                $('.filter_translations_btn_translate[data-inpagetranslationid=' + key + ']').addClass('alert-warning');\n            } else if (translationinfo.goodtranslation) {\n                $('.filter_translations_btn_translate[data-inpagetranslationid=' + key + ']').addClass('alert-success');\n            }\n        },\n        'findElementsDirectlyContainingText': function (ancestor, text) {\n            var elements = [];\n            walk(ancestor);\n            return elements;\n\n            function walk(element) {\n                var n = element.childNodes.length;\n                for (var i = 0; i < n; i++) {\n                    var child = element.childNodes[i];\n                    if (child.nodeType === 3 && child.data.indexOf(text) !== -1) {\n                        elements.push(element);\n                        break;\n                    }\n                }\n                for (var i = 0; i < n; i++) {\n                    var child = element.childNodes[i];\n                    if (child.nodeType === 1) {\n                        walk(child);\n                    }\n                }\n            }\n        },\n        objects: {}\n    };\n\n    return translation_button;\n});\n"],"file":"translation_button.min.js"}